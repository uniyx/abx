<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ABX Web Audio Test</title>
  <style>
    button {
      margin: 8px;
      padding: 10px 16px;
      font-size: 16px;
    }
    #controls {
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <h1>ABX Audio Test (Web Audio API)</h1>

  <form action="/" method="post" enctype="multipart/form-data">
    <input type="file" name="file" accept=".flac" required>
    <button type="submit">Upload and Convert</button>
  </form>

  {% if flac_base %}
    <div id="controls">
      <h2>Controls</h2>
      <button onclick="startTest()">Start Test</button>
      <button onclick="switchToA()">Switch to A</button>
      <button onclick="switchToB()">Switch to B</button>
      <button onclick="stopTest()">Stop</button>
    </div>

    <p id="status">Status: Not started</p>

    <script>
      let audioContext;
      let sourceA, sourceB;
      let gainA, gainB;
      let playing = false;

      async function loadAudio(url) {
        const res = await fetch(url);
        const arrayBuffer = await res.arrayBuffer();
        return await audioContext.decodeAudioData(arrayBuffer);
      }

      async function startTest() {
        if (playing) return;
        playing = true;
        document.getElementById("status").textContent = "Status: Playing";

        audioContext = new (window.AudioContext || window.webkitAudioContext)();

        const bufferA = await loadAudio("{{ url_for('audio', filename=flac_base + '_a.wav') }}");
        const bufferB = await loadAudio("{{ url_for('audio', filename=flac_base + '_b.wav') }}");

        sourceA = audioContext.createBufferSource();
        sourceB = audioContext.createBufferSource();
        sourceA.buffer = bufferA;
        sourceB.buffer = bufferB;

        gainA = audioContext.createGain();
        gainB = audioContext.createGain();

        sourceA.connect(gainA).connect(audioContext.destination);
        sourceB.connect(gainB).connect(audioContext.destination);

        gainA.gain.value = 0;
        gainB.gain.value = 0;

        sourceA.start();
        sourceB.start();
      }

      function switchToA() {
        if (!playing) return;
        gainA.gain.setValueAtTime(1, audioContext.currentTime);
        gainB.gain.setValueAtTime(0, audioContext.currentTime);
        document.getElementById("status").textContent = "Status: Listening to A";
      }

      function switchToB() {
        if (!playing) return;
        gainA.gain.setValueAtTime(0, audioContext.currentTime);
        gainB.gain.setValueAtTime(1, audioContext.currentTime);
        document.getElementById("status").textContent = "Status: Listening to B";
      }

      function stopTest() {
        if (!playing) return;
        sourceA.stop();
        sourceB.stop();
        playing = false;
        document.getElementById("status").textContent = "Status: Stopped";
      }
    </script>
  {% endif %}
</body>
</html>
